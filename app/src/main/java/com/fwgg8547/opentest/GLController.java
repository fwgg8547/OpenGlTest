package com.fwgg8547.opentest;

import java.util.List;
import java.util.ArrayList;
import android.view.MotionEvent;
import android.graphics.*;
import java.util.*;

public class GLController implements GlSurf.Callback, ScreenModel.Callback
{
	private final static String TAG = "GLController";
	private List<SpriteModel> mModels;
	private TreeManager mTree;
	private boolean mIsDrag = false;
	private List<Item> mDragItem;

	public GLController()
	{
		mModels = new ArrayList<SpriteModel>();
		mTree = new TreeManager();
		ScreenModel.getInstance().setCallback(this);
	}

	public void onScreenChange(){
		boolean b = mTree.initialize(ScreenModel.getInstance().getScreenInfo());
		
		if(b){
			Iterator it = mModels.iterator();
			while(it.hasNext()){
				SpriteModel m = (SpriteModel)it.next();
				mTree.registModel(m);
			}
		}
	}
	
	public void addModel(SpriteModel m)
	{
		mModels.add(m);
	}

	public void addModelList(List<SpriteModel> ml){
		mModels.addAll(ml);
	}
	
	public boolean onTouchEvent(MotionEvent event)
	{
		RectF screen = ScreenModel.getInstance().getScreenInfo();
		float tx = event.getX() ;
		float ty = screen.height() - event.getY();
		
		
		if(event.getAction() == MotionEvent.ACTION_DOWN)
		{
			Lg.i(TAG, "touch x"+tx + " y "+ty);
			mDragItem = mTree.getCollisionList(TreeManager.MAX_LEVEL, tx, ty);
			Lg.i(TAG, "cl " + mDragItem.size());
			if(mDragItem.size() > 0){
				mIsDrag = true;
			}
			/*
			Iterator it = mModels.iterator();
			while(it.hasNext()){
				SpriteModel m = (SpriteModel)it.next();
				if(m.conflict(tx, ty))
				{
					Lg.i(TAG, "hit");
					int index = m.getIndexOfConflict();
				}
			}
			*/
		} else if (event.getAction() == MotionEvent.ACTION_MOVE){
			if(!mIsDrag){
				return true;
			}
			
			Iterator it = mDragItem.iterator();
			while(it.hasNext()){
				Item itm = (Item)it.next();
				//Lg.i(TAG, "id " +itm.mId +" " +itm.getSpriteId());
				//itm.moveSingle(tx, ty);
				itm.moveRail(tx,ty);
			}
			
		} else if (event.getAction() == MotionEvent.ACTION_UP){
			Lg.i(TAG, "release x"+tx + " y "+ty);
			mTree.refreshConllisionList(mDragItem);
			mIsDrag = false;
			mDragItem = null;
		}
		
		return true;
	}

	public void onUpdate()
	{
		/*
			if(mMoveType == 0){
			mRoad.scrollup(mDelta);
			
			} else {
			mDeg++;
			mRoad.roll(100f, mDeg);
			}
		*/
		//mLayer.update();
	}
}
